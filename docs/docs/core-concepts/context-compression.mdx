---
title: 上下文压缩
description: OpenCowork 的上下文压缩机制，防止超出 token 限制。
---

# 上下文压缩 / Context Compression

当对话历史增长时，OpenCowork 会自动压缩上下文以防止超出模型的 token 限制。

## 两种压缩策略 / Strategies

### 预压缩（Pre-compress）

在每次 Agent 循环迭代前执行，清除过期的工具结果：

- 将超过 15 分钟的工具结果标记为过期
- 用占位符替换过期内容，减少 token 消耗
- 不改变对话结构，保留工具调用记录

### 完整压缩（Full Compress）

当 token 数超过阈值时触发：

1. 调用 LLM 对历史对话生成摘要
2. 用摘要替换旧消息
3. 保留最近 N 条消息不压缩

## 触发条件 / Triggers

```typescript
// token 阈值（可配置）
const COMPRESS_THRESHOLD = 100_000;  // 触发完整压缩
const PRE_COMPRESS_THRESHOLD = 80_000;  // 触发预压缩
```

## 时间戳过滤 / Timestamp Filtering

插件消息解析器使用 15 分钟时间戳过滤，丢弃过期消息，防止重复处理历史消息。
